<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Product - BlockVerify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <header id="navbar">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="navbar-brand">
                    <i class="fas fa-cube"></i> BlockVerify
                </a>
                <div class="navbar-menu">
                    <a href="index.html" class="navbar-link">Home</a>
                    <a href="verifyProducts.html" class="navbar-link active">Verify</a>
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                </div>
            </nav>
        </div>
    </header>

    <section class="hero-section" style="min-height: calc(100vh - 80px); padding-top: 100px;">
        <div class="container">
            <div class="row" style="align-items: flex-start;">
                <div class="col-6 fade-in-up">
                    <h1 class="hero-title" style="font-size: 3.5rem; text-align: left;">Verify Authenticity</h1>
                    <p class="hero-subtitle" style="text-align: left; margin-left: 0;">
                        Scan the QR code or enter the product serial number to verify its entire supply chain history on the blockchain.
                    </p>
                    
                    <div class="card" style="margin-top: 2rem;">
                        <div class="form-group">
                            <label class="form-label">Product Serial Number</label>
                            <div class="input-with-icon" style="position: relative;">
                                <input type="text" class="form-control" id="productSN" placeholder="Enter Serial Number (e.g., SN-12345)">
                                <i class="fas fa-barcode" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Consumer Code (Optional)</label>
                            <div class="input-with-icon" style="position: relative;">
                                <input type="text" class="form-control" id="consumerCode" placeholder="Enter Consumer Code">
                                <i class="fas fa-user-lock" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-block btn-verify-product" style="width: 100%;">
                            <i class="fas fa-search"></i> Verify Product
                        </button>
                    </div>
                </div>
                
                <div class="col-6 fade-in-up delay-100">
                    <div class="card" style="min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0f172a; border: 1px solid var(--border-color); position: relative; overflow: hidden; padding: 1rem;">
                        <div id="reader" style="width: 100%; border-radius: 8px; overflow: hidden;"></div>
                        
                        <div id="camera-placeholder" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            <i class="fas fa-qrcode fa-4x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Scan QR Code to Verify</p>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1rem; width: 100%;">
                            <button id="start-camera-btn" class="btn btn-outline-primary btn-sm" style="flex: 1;">
                                <i class="fas fa-camera"></i> Start Camera
                            </button>
                            <button id="stop-camera-btn" class="btn btn-outline-danger btn-sm" style="flex: 1; display: none;">
                                <i class="fas fa-stop"></i> Stop Camera
                            </button>
                            <button id="upload-qr-btn" class="btn btn-outline-secondary btn-sm" style="flex: 1;">
                                <i class="fas fa-upload"></i> Upload QR
                            </button>
                            <input type="file" id="qr-input-file" accept="image/*" style="display:none">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-container" style="margin-top: 4rem;">
                <!-- Loading State -->
                <div id="verification-loading" style="display: none; text-align: center; padding: 2rem;">
                    <i class="fas fa-circle-notch fa-spin fa-3x" style="color: var(--primary-color);"></i>
                    <p style="margin-top: 1rem;">Verifying on Blockchain...</p>
                </div>

                <!-- Authentic Result -->
                <div id="authentic-result" class="result-box authentic">
                    <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 1rem;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="result-title" style="color: var(--success-color);">Authentic Product</h2>
                    <p class="verification-message">This product is verified and authentic.</p>
                    
                    <div class="card" style="margin-top: 2rem; text-align: left;">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Product Name:</strong> <span class="product-name">Nike Air Max</span></p>
                                <p><strong>Serial Number:</strong> <span class="product-id">SN-12345</span></p>
                                <p><strong>Brand:</strong> <span class="product-brand">Nike</span></p>
                            </div>
                            <div class="col-6">
                                <p><strong>Price:</strong> <span class="product-price">$120</span></p>
                                <p><strong>Manufacturer:</strong> <span class="manufacturer-id">0x123...</span></p>
                                <p><strong>Seller:</strong> <span class="seller-id">0x456...</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Warning Result -->
                <div id="warning-result" class="result-box warning">
                    <div style="font-size: 4rem; color: var(--warning-color); margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="result-title" style="color: var(--warning-color);">Warning</h2>
                    <p class="verification-message">This product is authentic but has issues.</p>
                    
                    <div class="card" style="margin-top: 2rem; text-align: left;">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Product Name:</strong> <span class="product-name">-</span></p>
                                <p><strong>Serial Number:</strong> <span class="product-id">-</span></p>
                            </div>
                            <div class="col-6">
                                <p><strong>Brand:</strong> <span class="product-brand">-</span></p>
                                <p><strong>Price:</strong> <span class="product-price">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Counterfeit Result -->
                <div id="counterfeit-result" class="result-box counterfeit">
                    <div style="font-size: 4rem; color: var(--danger-color); margin-bottom: 1rem;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <h2 class="result-title" style="color: var(--danger-color);">Product Not Found</h2>
                    <p class="verification-message">This product does not exist on the blockchain.</p>
                    <p>Serial Number: <span class="product-id font-mono"></span></p>
                </div>
            </div>
        </div>
    </section>
    
    <style>
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Initialize app
        $(window).on('load', function() {
            BlockchainApp.init('verify');
            initQRScanner();
        });

        let html5QrcodeScanner;

        function initQRScanner() {
            html5QrcodeScanner = new Html5Qrcode("reader");

            // Camera Button
            $('#start-camera-btn').on('click', function() {
                $('#camera-placeholder').hide();
                $('#start-camera-btn').hide();
                $('#stop-camera-btn').show();
                
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    console.error("Error starting camera", err);
                    alert("Error starting camera: " + err);
                    stopCamera();
                });
            });

            // Stop Camera Button
            $('#stop-camera-btn').on('click', function() {
                stopCamera();
            });

            // Upload Button
            $('#upload-qr-btn').on('click', function() {
                $('#qr-input-file').click();
            });

            // File Input Change
            $('#qr-input-file').on('change', function(e) {
                if (e.target.files.length == 0) return;

                const imageFile = e.target.files[0];
                
                // Scan file
                html5QrcodeScanner.scanFile(imageFile, true)
                .then(decodedText => {
                    onScanSuccess(decodedText);
                })
                .catch(err => {
                    console.error("Error scanning file", err);
                    alert("Error scanning file: " + err);
                });
            });
        }

        function stopCamera() {
            if(html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().then(() => {
                    $('#camera-placeholder').show();
                    $('#start-camera-btn').show();
                    $('#stop-camera-btn').hide();
                    $('#reader').empty();
                }).catch(err => {
                    console.error("Failed to stop camera", err);
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            
            // Stop camera if running
            stopCamera();

            try {
                // Try to parse as JSON (our format)
                const data = JSON.parse(decodedText);
                if (data.serial) {
                    $('#productSN').val(data.serial);
                    if (data.consumer) $('#consumerCode').val(data.consumer);
                    
                    // Trigger verification
                    $('.btn-verify-product').click();
                } else {
                    alert("Invalid QR Code format for BlockVerify");
                }
            } catch (e) {
                // Fallback for plain text serial
                $('#productSN').val(decodedText);
                $('.btn-verify-product').click();
            }
        }

        function onScanFailure(error) {
            // handle scan failure, usually better to ignore and keep scanning.
            // console.warn(`Code scan error = ${error}`);
        }
    </script>
</body>
</html>
